<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Terminal Portfolio E2E Tests</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #0a0e27; color: #00ff41; padding: 20px; }
        .test-pass { color: #00ff88; }
        .test-fail { color: #ff0041; }
        .test-running { color: #ffaa00; }
        .test-section { margin: 20px 0; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .test-result { margin: 5px 0; }
        #terminal-frame { width: 100%; height: 400px; border: 1px solid #333; margin: 20px 0; }
        .journey { margin: 30px 0; padding: 20px; border: 1px solid #00ff4133; }
        .step { margin: 10px 0; padding-left: 20px; }
    </style>
</head>
<body>
    <h1>Terminal Portfolio E2E Tests</h1>
    <p>Testing the 3 most critical user journeys that would break the portfolio's purpose.</p>

    <div id="test-results"></div>

    <!-- Hidden iframe for testing the actual terminal -->
    <iframe id="terminal-frame" src="../terminal-portfolio.html" style="display: none;"></iframe>

    <script>
        // E2E Test Framework - MINIMAL but EFFECTIVE
        class E2ETestSuite {
            constructor() {
                this.results = [];
                this.currentJourney = '';
            }

            async runJourney(name, steps) {
                this.currentJourney = name;
                this.log(`ðŸš€ Starting journey: ${name}`, 'running');

                let allPassed = true;
                for (let i = 0; i < steps.length; i++) {
                    const step = steps[i];
                    try {
                        this.log(`  Step ${i+1}: ${step.name}`, 'running');
                        const result = await step.test();
                        this.log(`  âœ“ Step ${i+1}: ${step.name}`, 'pass');
                    } catch (error) {
                        this.log(`  âœ— Step ${i+1}: ${step.name} - ${error.message}`, 'fail');
                        allPassed = false;
                        break; // Stop journey on first failure
                    }
                }

                if (allPassed) {
                    this.log(`âœ… Journey completed: ${name}`, 'pass');
                } else {
                    this.log(`âŒ Journey failed: ${name}`, 'fail');
                }

                return allPassed;
            }

            log(message, status) {
                const className = `test-${status}`;
                this.results.push({ message, status, journey: this.currentJourney });
                this.render();
            }

            render() {
                const container = document.getElementById('test-results');
                let html = '';

                // Group by journey
                const journeys = {};
                this.results.forEach(result => {
                    if (!journeys[result.journey]) {
                        journeys[result.journey] = [];
                    }
                    journeys[result.journey].push(result);
                });

                Object.entries(journeys).forEach(([journey, results]) => {
                    html += `<div class="journey"><h3>Journey: ${journey}</h3>`;
                    results.forEach(result => {
                        const className = `test-${result.status}`;
                        html += `<div class="step"><span class="${className}">${result.message}</span></div>`;
                    });
                    html += '</div>';
                });

                container.innerHTML = html;
            }

            // Utility to wait for terminal to load
            async waitForTerminal(iframe) {
                return new Promise((resolve, reject) => {
                    let pollInterval = null;

                    const cleanup = () => {
                        clearTimeout(timeout);
                        if (pollInterval) {
                            clearInterval(pollInterval);
                            pollInterval = null;
                        }
                        iframe.removeEventListener('load', onLoad);
                    };

                    const tryResolve = () => {
                        try {
                            const terminalDoc = iframe.contentDocument;
                            const terminalWindow = iframe.contentWindow;
                            const terminal = terminalWindow && terminalWindow.terminal;

                            const welcomeReady = terminal && terminal.output && terminal.output.innerHTML.includes('Welcome to Fadi Al Zuabi');

                            if (terminal && terminal.commands && terminal.output && terminal.input && welcomeReady) {
                                cleanup();
                                resolve({ doc: terminalDoc, terminal });
                                return true;
                            }
                        } catch (e) {
                            cleanup();
                            reject(new Error('Cannot access terminal: ' + e.message));
                            return true;
                        }
                        return false;
                    };

                    const startPolling = () => {
                        if (pollInterval) {
                            return;
                        }
                        pollInterval = setInterval(() => {
                            if (tryResolve()) {
                                if (pollInterval) {
                                    clearInterval(pollInterval);
                                    pollInterval = null;
                                }
                            }
                        }, 200);
                    };

                    const onLoad = () => {
                        setTimeout(() => {
                            if (!tryResolve()) {
                                startPolling();
                            }
                        }, 300);
                    };

                    const timeout = setTimeout(() => {
                        cleanup();
                        reject(new Error('Terminal load timeout'));
                    }, 10000);

                    iframe.addEventListener('load', onLoad);

                    if (!tryResolve()) {
                        if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                            onLoad();
                        } else {
                            startPolling();
                        }
                    }
                });
            }

            // Utility to simulate typing a command
            async typeCommand(terminal, command) {
                const input = terminal.input;
                input.value = command;

                // Simulate Enter key press
                const enterEvent = new KeyboardEvent('keydown', {
                    key: 'Enter',
                    code: 'Enter',
                    keyCode: 13
                });
                input.dispatchEvent(enterEvent);

                // Wait for command to execute
                await this.delay(500);
            }

            // Utility to check if output contains expected text
            checkOutput(terminal, expectedText) {
                const output = terminal.output.innerHTML;
                return output.includes(expectedText);
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize the test suite
        const e2eTests = new E2ETestSuite();

        // CRITICAL JOURNEY 1: "Can I learn about Fadi's background?"
        // This is THE most important path - if visitors can't learn about Fadi, the portfolio fails
        const journey1 = [
            {
                name: 'Terminal loads and shows welcome message',
                test: async () => {
                    const iframe = document.getElementById('terminal-frame');
                    iframe.style.display = 'block';
                    const { doc, terminal } = await e2eTests.waitForTerminal(iframe);

                    if (!terminal) {
                        throw new Error('Terminal object not found');
                    }

                    // Check if welcome message is shown
                    const output = terminal.output.innerHTML;
                    if (!output.includes('Welcome to Fadi Al Zuabi')) {
                        throw new Error('Welcome message not displayed');
                    }

                    return true;
                }
            },
            {
                name: 'About command shows professional background',
                test: async () => {
                    const iframe = document.getElementById('terminal-frame');
                    const { terminal } = await e2eTests.waitForTerminal(iframe);

                    await e2eTests.typeCommand(terminal, 'about');

                    if (!e2eTests.checkOutput(terminal, 'Fadi Al Zuabi') ||
                        !e2eTests.checkOutput(terminal, 'Firmware')) {
                        throw new Error('About command did not show professional info');
                    }

                    return true;
                }
            },
            {
                name: 'Skills command shows technical expertise',
                test: async () => {
                    const iframe = document.getElementById('terminal-frame');
                    const { terminal } = await e2eTests.waitForTerminal(iframe);

                    await e2eTests.typeCommand(terminal, 'skills');

                    if (!e2eTests.checkOutput(terminal, 'Programming Languages') ||
                        !e2eTests.checkOutput(terminal, 'C/C++')) {
                        throw new Error('Skills command did not show technical skills');
                    }

                    return true;
                }
            },
            {
                name: 'Experience command shows work history',
                test: async () => {
                    const iframe = document.getElementById('terminal-frame');
                    const { terminal } = await e2eTests.waitForTerminal(iframe);

                    await e2eTests.typeCommand(terminal, 'experience');

                    if (!e2eTests.checkOutput(terminal, 'SK Hynix Solidigm') ||
                        !e2eTests.checkOutput(terminal, 'Firmware Engineer')) {
                        throw new Error('Experience command did not show work history');
                    }

                    return true;
                }
            }
        ];

        // CRITICAL JOURNEY 2: "How can I contact Fadi?"
        // This is the conversion path - if visitors can't contact him, no business value
        const journey2 = [
            {
                name: 'Contact command shows all contact methods',
                test: async () => {
                    const iframe = document.getElementById('terminal-frame');
                    const { terminal } = await e2eTests.waitForTerminal(iframe);

                    await e2eTests.typeCommand(terminal, 'contact');

                    if (!e2eTests.checkOutput(terminal, 'fadi.b.zuabi@gmail.com') ||
                        !e2eTests.checkOutput(terminal, 'LinkedIn') ||
                        !e2eTests.checkOutput(terminal, 'GitHub')) {
                        throw new Error('Contact command did not show contact information');
                    }

                    return true;
                }
            },
            {
                name: 'Email command initiates email contact',
                test: async () => {
                    const iframe = document.getElementById('terminal-frame');
                    const { terminal } = await e2eTests.waitForTerminal(iframe);

                    // Store original location
                    const originalHref = iframe.contentWindow.location.href;

                    await e2eTests.typeCommand(terminal, 'email');

                    // Check if email client was attempted to be opened
                    if (!e2eTests.checkOutput(terminal, 'Opening email client')) {
                        throw new Error('Email command did not attempt to open email client');
                    }

                    return true;
                }
            },
            {
                name: 'GitHub command opens profile',
                test: async () => {
                    const iframe = document.getElementById('terminal-frame');
                    const { terminal } = await e2eTests.waitForTerminal(iframe);

                    // Mock window.open to capture the call
                    let openedUrl = null;
                    iframe.contentWindow.open = (url) => { openedUrl = url; };

                    await e2eTests.typeCommand(terminal, 'github');

                    if (!e2eTests.checkOutput(terminal, 'Opening GitHub profile')) {
                        throw new Error('GitHub command did not show opening message');
                    }

                    return true;
                }
            }
        ];

        // CRITICAL JOURNEY 3: "Does the terminal actually work?"
        // This tests the core UX - if the terminal feels broken, visitors leave
        const journey3 = [
            {
                name: 'Help command shows available commands',
                test: async () => {
                    const iframe = document.getElementById('terminal-frame');
                    const { terminal } = await e2eTests.waitForTerminal(iframe);

                    await e2eTests.typeCommand(terminal, 'help');

                    if (!e2eTests.checkOutput(terminal, 'Available Commands') ||
                        !e2eTests.checkOutput(terminal, 'about') ||
                        !e2eTests.checkOutput(terminal, 'contact')) {
                        throw new Error('Help command did not show command list');
                    }

                    return true;
                }
            },
            {
                name: 'File system navigation works (ls, cd)',
                test: async () => {
                    const iframe = document.getElementById('terminal-frame');
                    const { terminal } = await e2eTests.waitForTerminal(iframe);

                    // List root directory
                    await e2eTests.typeCommand(terminal, 'ls');
                    if (!e2eTests.checkOutput(terminal, 'projects')) {
                        throw new Error('ls command did not show directories');
                    }

                    // Change to projects directory
                    await e2eTests.typeCommand(terminal, 'cd projects');
                    if (terminal.currentPath !== '~/projects') {
                        throw new Error('cd command did not change directory');
                    }

                    return true;
                }
            },
            {
                name: 'Invalid commands show helpful errors',
                test: async () => {
                    const iframe = document.getElementById('terminal-frame');
                    const { terminal } = await e2eTests.waitForTerminal(iframe);

                    await e2eTests.typeCommand(terminal, 'invalidcommand123');

                    if (!e2eTests.checkOutput(terminal, 'Command not found') ||
                        !e2eTests.checkOutput(terminal, 'help')) {
                        throw new Error('Invalid command did not show helpful error');
                    }

                    return true;
                }
            }
        ];

        // Run the tests
        async function runAllTests() {
            console.log('ðŸš€ Starting E2E Test Suite');

            let passedJourneys = 0;

            if (await e2eTests.runJourney('Professional Info Discovery', journey1)) {
                passedJourneys++;
            }

            if (await e2eTests.runJourney('Contact Conversion Path', journey2)) {
                passedJourneys++;
            }

            if (await e2eTests.runJourney('Terminal UX Validation', journey3)) {
                passedJourneys++;
            }

            // Final summary
            const summary = `\nðŸ“Š FINAL RESULTS: ${passedJourneys}/3 critical user journeys passed\n`;
            e2eTests.log(summary, passedJourneys === 3 ? 'pass' : 'fail');

            if (passedJourneys === 3) {
                e2eTests.log('âœ… Portfolio is ready for users!', 'pass');
            } else {
                e2eTests.log('âŒ Critical issues found - fix before deployment', 'fail');
            }
        }

        // Auto-run tests when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runAllTests, 1000); // Give iframe time to load
        });

        // Manual test trigger
        window.runTests = runAllTests;
    </script>

    <div style="margin-top: 40px; padding: 20px; border: 1px solid #333;">
        <h3>Test Philosophy</h3>
        <p><strong>NOT TESTING:</strong></p>
        <ul>
            <li>Matrix rain animation (decorative)</li>
            <li>Typing animation speed (cosmetic)</li>
            <li>CSS styling details (visual polish)</li>
            <li>Command history edge cases (power user feature)</li>
            <li>Autocomplete variations (nice to have)</li>
            <li>Error message wording (copy details)</li>
        </ul>

        <p><strong>TESTING ONLY:</strong></p>
        <ul>
            <li>Can users learn about Fadi's background?</li>
            <li>Can users contact Fadi?</li>
            <li>Does the terminal work reliably?</li>
        </ul>

        <p><em>If these 3 journeys work, the portfolio succeeds. If they don't, it fails.</em></p>

        <button onclick="runTests()" style="background: #00ff41; color: #000; border: none; padding: 10px 20px; cursor: pointer;">
            Re-run Tests
        </button>
    </div>
</body>
</html>